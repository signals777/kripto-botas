<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prekybos Panelė</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-dark text-white">
<div class="container mt-5">

    {% if session['user'] %}
        <h2 class="text-info">Sveiki, {{ session['user'] }}!</h2>
        <div class="mb-3">
            <a href="/logout" class="btn btn-outline-warning">Atsijungti</a>
        </div>

        <form method="post" action="/">
            <div class="mb-3">
                <label for="n_pairs" class="form-label">Porų skaičius</label>
                <input type="number" class="form-control" id="n_pairs" name="n_pairs" value="{{ settings['n_pairs'] }}">
            </div>

            <div class="mb-3">
                <label class="form-label">Techniniai filtrai</label><br>
                {% for f in all_filters %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="ta_filters" value="{{ f }}" {% if f in settings['ta_filters'] %}checked{% endif %}>
                        <label class="form-check-label text-light">{{ f }}</label>
                    </div>
                {% endfor %}
            </div>

            <button type="submit" class="btn btn-success">Atnaujinti nustatymus</button>
        </form>

        <hr class="border-light">

        <div class="d-flex justify-content-between align-items-center my-3">
            <h4>Boto būsena: 
                {% if bot_status == 'Veikia' %}
                    <span class="badge bg-success">Veikia</span>
                {% else %}
                    <span class="badge bg-danger">Sustabdyta</span>
                {% endif %}
            </h4>
            <div>
                <a href="/start" class="btn btn-primary">Start</a>
                <a href="/stop" class="btn btn-danger">Stop</a>
            </div>
        </div>

        <div class="mb-3">
            <h5>Balansas: <span class="text-info">{{ balance }} USDT</span></h5>
        </div>

        <canvas id="balanceChart" height="80"></canvas>
        <script>
            const ctx = document.getElementById('balanceChart');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: {{ times|tojson }},
                    datasets: [{
                        label: 'Balanso pokytis',
                        data: {{ graph|tojson }},
                        borderWidth: 2,
                        fill: true,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: false },
                        x: { ticks: { color: "#ccc" } }
                    }
                }
            });
        </script>

        <hr class="border-light">
        <h4 class="mt-4">Paskutiniai sandoriai</h4>
        <table class="table table-dark table-striped">
            <thead>
            <tr>
                <th>Laikas</th>
                <th>Pora</th>
                <th>Kryptis</th>
                <th>Kaina</th>
                <th>Pozicija</th>
            </tr>
            </thead>
            <tbody>
            {% for t in trade_history %}
                <tr>
                    <td>{{ t.laikas }}</td>
                    <td>{{ t.pora }}</td>
                    <td>{{ t.kryptis }}</td>
                    <td>{{ t.kaina }}</td>
                    <td>{{ t.pozicija }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <hr class="border-light">

        <form method="post" action="/change_password">
            <h5>Slaptažodžio keitimas</h5>
            <div class="row mb-3">
                <div class="col">
                    <input class="form-control" name="old_password" type="password" placeholder="Senas slaptažodis">
                </div>
                <div class="col">
                    <input class="form-control" name="new_password" type="password" placeholder="Naujas slaptažodis">
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-light">Keisti</button>
                </div>
            </div>
        </form>
    {% else %}
        <h3 class="text-light mb-3">Prisijungimas</h3>
        <form method="post" action="/login" class="bg-secondary p-4 rounded shadow">
            <div class="mb-3">
                <label for="username" class="form-label">El. paštas</label>
                <input class="form-control" type="text" name="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Slaptažodis</label>
                <input class="form-control" type="password" name="password" required>
            </div>
            <button class="btn btn-light">Prisijungti</button>
        </form>
    {% endif %}

</div>
</body>
</html>
